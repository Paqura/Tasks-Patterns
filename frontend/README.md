# PTS Global. Frontend

Приложение фронтенд-части сайта.

## Зависимости

* NodeJS ^18
* Yarn
* NextJS
* React
* Typescript

## Локальная разработка

Установить зависимости

```
yarn install
```

Запустить в dev-режиме 

```
yarn dev
```

При запуске в локальном режиме по умолчанию приложение будет обращаться за данными к админке, запущенной по инструкции в [admin/Readme](../admin/README.md)

Для этого указаны нужные переменные окружения в файле `.env`


## Сборка и запуск в prod-режиме

Установить зависимости

```
yarn install
```

Запустить сборку

```
yarn build
```

Запуск 

```
yarn start
```

При запуске в prod-режиме по умолчанию переменные окружения берутся из файла '.env'. Но также можно переменные передать явно при сборке и запуске.


## Переменные окружения

`NEXT_PUBLIC_ADMIN_API_URL` - url где развернута админка

`ADMIN_API_KEY` - ключ авторизованного доступа к админке

`MEILISEARCH_HOST` - url где развернут meilisearch

`MEILISEARCH_APP_KEY` - ключ для доступа к meilisearch

`NEXT_PUBLIC_YM_ID` - Счетчик яндекс-метрики. Можно не передавать при локальной разработке.

'NEXT_PUBLIC_YANDEX_VERIFICATION_ID' - ключ для верификации владельца сайта в яндекс-метрике 

## Получение данных

Все обращения к API админки должны происходить при серверном рендеринге. С клиента запросы к админке уходить не должны.

Если клиент должен обращаться к админке как авторизованный пользователь, то можно при запуске приложения передать переменную окружения `ADMIN_API_KEY`. В ней нужно передать api-ключ сгенерированный в админке. Подробнее читай в [admin/Readme](../admin/README.md)

### Типизация

В проекте админки лежат файлы с типами структуры данных админки. Эти тайпинги подключены в проект как внешняя зависимость.

При изменении структуры данных в админке нужно вручную сгенерировать новые тапинги. Для этого в директории проекта админки нужно выполнить

```
yarn generate-types
```

Чтобы использовать сгенерированные типы нужно импортировать утилитарные типы из проекта админки

```
import { Response } from '@admin/general-schemas'

<...>

const response: Response<'api::product.product'> = await fetchProduct(id)
```

При этом generic-параметр типа `Response` типизирован и тип `Response<'api::product.product'>` вернет структуру данных сущности продукта.


### Ошибки получения данных

При обращении к API strapi возможны следующие ошибки:


*403* - В админке не установлены права на обращение к запрашиваемой сушности. О том как устанавливать права читай в [admin/Readme](../admin/README.md)

*404* – Если url сформирован правильно, то такая ошибка говорит, что в админке появилась сущность (обычно в Single Types), у которой есть обязательные поля но нет дефолтного значения. Из-за этого strapi не может создать её в БД и как следствие считает, что её нет. В этому случае нужно посмотреть запрос какой сущности упал, пройти в админку и заполнить данные для этой сущности.

*401* – Если при обращении к API устанавливается некорректный заголовок авторизации. Заголовок авторизации устанавливается если передать переменную окружения ADMIN_API_KEY. Если этот ключ не принадлежит админке, у которой запрашиваются данные, то админке вернет 401. Как сформировать этот ключ читай в [admin/Readme](../admin/README.md)

### Счетчик яндекс-метрики

На тестовых стендах подключен тестовый счетчик яндекс-метрики. 
На данный момент владелец этого счетчика Evgeny Chirko (https://github.com/packpacka).
При необходимости можно подключить для тестовых стендов любой другой счетчик через переменную окружения `NEXT_PUBLIC_YM_ID` в [Vault](https://vault.csssr.com:8200/ui/vault/secrets/secret/show/k8s/gke-csssr-testing/pts-global-frontend/everyone/secret)

## Линтинг

Линтинг JS/TS

```
yarn lint
```

Линтинг стилей

```
yarn style-lint
```

Проверка типов

```
yarn typechek
```

Запуск всех проверок

```
yarn check-all
```
