# PTS Global. Admin

Приложение бэкенд-части сайта.

## Зависимости

* NodeJS ^18
* Yarn
* Docker
* Strapi ^4

## Локальная разработка

Установить зависимости
```
yarn install
```

Запустить базу-данных 
```
yarn develop:database
```

База данных разворачивается в docker-контейнере. Кроме запущенного Docker ничего устанавливать дополнительно не нужно.


Запустить strapi 
```
yarn develop:strapi
```

При первом запуске Strapi создаст в проекте файл `.env` с базовым набором переменных окружения. 


Запустить meilisearch
```
develop:meilisearch
```
Сервис meilisearch разворачивается в docker-контейнере. Кроме запущенного Docker ничего устанавливать дополнительно не нужно.


## Запуск и сборка в prod-режиме

Процесс развертывания базы-данных и сервиса meilisearch лежит на плечах devops-инженеров. Параметры доступа к ним задаются через переменные окружения при сборке и запуске админки.
Если нужно запустить админку в prod-режиме на локальной машине, то можно запустить meiliseach и бд таким же образом как для dev-режима.

Чтобы запустить админку в prod-режиме нужно

Установить зависимости
```
yarn install
```

Запуск сборки
```
yarn build
```

Запуск админки
```
yarn start
```

Переменные окружения могут указываться в файле `.env` или напрямую при сборке и запуске. 

Отличие запуска админки в dev- и prod- режиме в том, что в dev-режиме в админке доступен раздел "Content type builder" – функционал изменения структуры данных через интерфейс админки (см раздел "Управление структурой данных"). 
В prod-режиме через этот раздел можно управлять только отображением полей сущностей – можно скрывать поля, изменять их порядок отображения в формах редактирования сущностей и тп.


## Переменные окружения для запуска strapi

Параметры БД
* `DATABASE_HOST` – адрес бд
* `DATABASE_PORT` – порт бд
* `DATABASE_NAME` – имя бд
* `DATABASE_USERNAME` – имя ползователя бд
* `DATABASE_PASSWORD` – пароль пользователя бд
* `DATABASE_SSL` – флаг использования ssl для доступа к бд

Параметры для отправки писем
* `EMAIL_PROVIDER` – тип email-провайдера. По умолчанию `nodemailer`
* `SMTP_HOST` – адрес smtp-сервера 
* `SMTP_PORT` – порт smtp-сервера
* `SMTP_USERNAME` – пользователь smtp-сервера
* `SMTP_PASSWORD` – пароль пользователя smtp-сервера
* `REQUESTS_EMAIL` – почта получателя уведомлений о новых заявках от посетителей сайта

Параметры поискогового сервиса
* `MEILISEARCH_HOST` – адрес развернутого meilisearch
* `MEILISEARCH_APP_KEY` - ключ доступа к meilisearch

Параметры хранилища медиа-файлов, загружаемых в админку
* `S3_ENABLED` – нужно ли загружать файлы в облачное s3-хранилище. Если флаг не передан, то файлы будут храниться на локальной машине. Если флаг передан, то все остальные переменные для s3 обязательны.
* `AWS_ACCESS_KEY_ID` – id-ключа для доступа к s3
* `AWS_SECRET_ACCESS_KEY` – значение ключа для доступа к s3
* `AWS_REGION` – регион s3
* `S3_BUCKET` – бакет s3
* `S3_ENDPOINT` – эндпоинт s3. 

Адреса клиентов
* ALLOW_ORIGINS - список origin-ов (через запятую), с которых разрешено обращение к api админки (интерфейс админки, фронтенд, meilisearch).

## Управление структурой данных

### Управление через интерфейс
Strapi поддерживает возможность управления структурой данных через интерфейс.
Если strapi запущен в dev-режиме, то в интерфейсе доступен раздел `Content type builder`. В нем можно добавлять/удалять/редактировать сущности и поля в них. 

Подробнее о функционале редактирования сущностей можно почитать в [документации Strapi](https://docs.strapi.io/user-docs/content-type-builder).

При сохранении изменений через Content Type Builder, strapi автоматически делает изменения в файлах конфигурации сущностей прямо в файлах проекта. Эти изменения должны быть закоммичены. 

### Управление через код
По скольку страпи хранит конфигурацию структур данных в коде проекта, как следствие он поддерживает и управление структурой данных через код. Тоесть можно зайти в кофиг любой структуры и вручную добавить/изменить/удалить какие-то аттрибуты сущности. Запущенный страпи автоматически подтянет эти изменения в базу данных и в отобразит в интерфейсе админки.

### Применение чужих изменений
Когда другой разработчик подтянет себе изменения в файлах схемы данных, его локальный инстанс strapi автоматически применит эти изменения к своей базе данных и отобразит эти изменения в интерфейсе

**Важно** 

1) Если в разделе Single types появляется сущность, у которой есть обязательные поля, но для которых не указано значение по умолчанию, то Strapi  создаст схему для для этой сущности, и отобразит в интерфейсе, но при этом он не сможет создать значение для этой сущности в базе данных. Тогда при попытке запроса такой сущности с клиента, strapi ответит ошибкой 404. Чтобы это исправить, нужно через интерфейс заполнить данные для этой сущности.

2) Когда в SingleTypes или CollectionTypes появляется сущность, то по умолчанию для неё не будут установлены права доступа. Тогда при попытке запросить такую сущность через api strapi вернет ошибку 401. Чтобы это исправить нужно проставить прова доступа для этой сущности. Подробнее читай в разделе "Права доступа"

### Изменение существующих сущностей
При изменении существующих сущностей не нужно заного проставлять права доступа.

**Важно**
Если изменяется структура/тип существующего поля сущности на несовсестимый со старым, от старое значение будет удалено. Это важно помнить если админка и клиент будут деплоиться отдельно. Иначе может получиться ситуация, когда клиент всё еще ожидает в поле старую структуру данных, а админка поставляет новую. Также в этих полях могут быть важные данные, которые хорошо было бы не потерять.


### Генерация типов
В проекте подключена возможность генерировать типы структуры данных, управляемых через админку. Эти типы можно использовать в проекте frontend-а.

После того как в структуру данных внесены и сохранены изменения, нужно выполнить команду:
```
yarn generate-types
```

Сгенерированные типы будут положены в файл `schemas.d.ts`. Изменения в этом файле должны быть закоммичены. Вносить вручную изменения в этот файл не нужно.

Для доступа к этим типам из проекта frontend-а следует импортировать типы из файла `general-schemas-d.ts`. Он содержит утилитарные типы для работы со сгенерированной схемой данных. Этот файл не измененяется при генерации и внего можно вручную вносить изменения при необходимости.

## Права и роли

В strapi есть система управления ролями и правами (подробнее см. в [доке](https://docs.strapi.io/user-docs/users-roles-permissions))

### Типы доступа

Strapi поддерживает 2 типа доступа через api.
* Public 
* Authenticated

Публичным считается обращение к API если в запросе не указан заголовок авторизации `Authorization`.

Если же заголовок `Authorization` указан, то доступ считается авторизованным. При этом страпи валидирует содержимое заголовка авторизации, и если он указан не верно, то strapi веренет 401.

В проекте frontend-а поддерживается переменная окружения `ADMIN_API_KEY`. В неё предполагается передавать ключ авторизации.
Этот ключ можно сгенерировать в разделе `Settings -> API Tokens`.
При создании ключа можно указать конкретные права на сущности. Но мы используем режим `full-access`.

### Права
Strapi позволяет для каждой сущности указать права доступа для CRUD-операций. 
В зависимости от способа авторизации клиента при обращении к api админки, права доступа нужно указывать в одном из разделов: 
* Public (`Settings -> USERS & PERMISSIONS PLUGIN -> Roles -> Public`) 
* Authenticated (`Settings -> USERS & PERMISSIONS PLUGIN -> Roles -> Authenticated`)

Там в разделе "Permissions" можно для каждой сущности проставить галочки разрешающие разные типы операций (find, findOne, update, create, delete)


# Поисковый сервис

На клиенте есть функциональность поиска по сайту. Она реализована с помощью инструмента [Meilisearch](https://www.meilisearch.com/).
Meilisearch индексирует базу данных страпи, складывает нужные данные в свою базу. Поисковые запросы от клиента идут уже непосредственно к Meilisearch, который, в свою очередь, по запросу находит в своём индексе нужные результаты.

Чтобы управлять тем, какие именно данные из базы strapi будет индексировать meilisearch, к админке подключен одноименный плагин `meillisearch` (раздел `Plugins -> Meilisearch` в интерфейсе админки) . Он позволяет делать 2 вещи:
* Выбирать галочками, какие сущности админки будут попадать в индекс. Для нормальной работы поиска нужно выбрать сущности с именем "searchable-items" в колонке "INDEX NAME". Для добавления новых сущностей в поиск нужно сделать доработку в конфиг-файлах и добавить соответствующие функции-обработчики.
* Автоматически обновлять данные в индексе при изменении сущностей выбранных типов

Чтобы поисковый индекс заполнился данными, нужно в разделе плагина `Plugins -> Meilisearch` выбрать нужные сущности для индексации. На данный момент это Products(продукты), News-item (новости) и Analytic-article (статья аналитики)

Параметры доступа к meilisearch нужно передать через переменные окружения `MEILISEARCH_HOST` и `MEILISEARCH_APP_KEY`.

**Важно** 
Если изменяется структура данных какой-либо из сущностей, нужно выяснить, как структура этой сущности отправляется в индекс Meilisearch и доработать при необходимости. Логика формирования данных описана в файле `admin/config/meilisearchPluginConfig.ts`. 
